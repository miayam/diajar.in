---
import { slides } from "@/utils";
---

<div class="w-full pt-4 flex justify-center">
    <div
        id="storiesContainer"
        class="relative w-full max-w-[40rem] px-4 h-[23rem] bg-white overflow-hidden flex flex-col"
    >
        <!-- Progress indicators -->
        <div id="progressContainer" class="flex gap-2.5 pt-4 pb-3 z-10">
            {
                slides.map((_, index) => (
                    <div
                        class="flex-1 md:h-1.2 h-1 bg-gray-300 rounded-lg overflow-hidden"
                        data-index={index}
                    >
                        <div class="progress-fill h-full bg-gray-900 w-0 rounded-sm transition-[width] duration-100" />
                    </div>
                ))
            }
        </div>

        <!-- Stories wrapper -->
        <div
            id="storiesWrapper"
            class="flex-1 relative mt-[3rem] overflow-hidden"
        >
            <div class="flex md:pl-[14.3%] pl-[9%] items-end gap-8 m-auto">
                <div class="flex gap-1 font-semibold items-center">
                    <span class="md:text-[3rem] text-[2.8rem]">7</span>
                    <span
                        class="w-10 leading-tight md:text-[1rem] text-[0.9rem]"
                        >Adab Pelajar</span
                    >
                </div>
            </div>
            {
                slides.map((slide, index) => (
                    <div
                        class="story-slide absolute top-0 left-0 w-full h-full flex flex-col justify-center items-center text-center opacity-0 transition-opacity duration-500"
                        data-index={index}
                    >
                        <div class="relative font-base md:w-[70%] w-[80%] gap-1 h-[45%] flex flex-col m-auto">
                            <div class="flex justify-start absolute left-0 md:top-2">
                                <span class="icon-left-quote md:text-5xl text-3xl" />
                            </div>
                            <div class="md:w-[77%] w-[90%] px-4 text-center m-auto leading-tight">
                                <div class="font-semibold text-mono md:text-2xl text-xl leading-tight px-4">
                                    {slide.text}
                                </div>

                                <div class="text-sm font-italic mt-3 p-0.5">
                                    â€” dipetik dari Al-Ghazali
                                </div>
                            </div>

                            <div class="flex justify-end absolute right-0 md:bottom-14 bottom-12">
                                <span class="icon-right-quote md:text-5xl text-3xl" />
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</div>

<style>
    .progress-fill.completed {
        width: 100%;
        background: var(--text-gray-900);
        transition: none;
    }

    .progress-fill.active {
        background: var(--text-gray-900);
        animation: progress linear forwards;
    }

    @keyframes progress {
        from {
            width: 0%;
        }
        to {
            width: 100%;
        }
    }

    .story-slide.active {
        opacity: 1;
    }
</style>
<script>
    class StoriesPlayer {
        private container: HTMLElement;
        private totalSlides: number;
        private currentIndex: number;
        private isPlaying: boolean;
        private isPaused: boolean;
        private pausedTime: number;
        private startTime: number;
        private duration: number;
        private slides: NodeListOf<HTMLElement>;

        constructor(container: HTMLElement, totalSlides: number) {
            this.container = container;
            this.totalSlides = totalSlides;
            this.currentIndex = 0;
            this.isPlaying = false;
            this.isPaused = false;
            this.pausedTime = 0;
            this.startTime = 0;
            this.duration = 5;
            this.slides = container.querySelectorAll(".story-slide");
        }

        public init(): void {
            this.showSlide(0);
            this.startStory();
        }

        private showSlide(index: number): void {
            if (index < 0 || index >= this.totalSlides) return;

            this.slides.forEach((slide, i) => {
                slide.classList.remove("active");
                if (i === index) {
                    slide.classList.add("active");
                }
            });

            this.currentIndex = index;
            this.updateProgressBars();
        }

        private updateProgressBars(): void {
            const progressBars =
                this.container.querySelectorAll<HTMLElement>("[data-index]");

            progressBars.forEach((bar, index) => {
                const fill = bar.querySelector<HTMLElement>(".progress-fill");
                if (!fill) return;

                fill.classList.remove("active");
                fill.style.animationDuration = "";
                fill.style.animationDelay = "";
                fill.removeEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );

                if (index < this.currentIndex) {
                    fill.classList.add("completed");
                    fill.style.width = "100%";
                    fill.style.background = "#121212";
                } else if (index === this.currentIndex) {
                    fill.classList.remove("completed");
                    fill.style.width = "0%";
                    fill.style.background = "#121212";
                } else {
                    fill.classList.remove("completed");
                    fill.style.width = "0%";
                    fill.style.background = "transparent";
                }
            });
        }

        private handleAnimationEnd = (): void => {
            if (!this.isPaused) {
                this.nextStory();
            }
        };

        private startStory(): void {
            if (this.currentIndex >= this.totalSlides) {
                this.complete();
                return;
            }

            this.isPlaying = true;
            this.isPaused = false;
            this.startTime = Date.now();

            const progressFill = this.container.querySelector<HTMLElement>(
                `[data-index="${this.currentIndex}"] .progress-fill`,
            );
            if (progressFill) {
                progressFill.removeEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
                progressFill.style.animationDuration = `${this.duration}s`;
                progressFill.classList.add("active");
                progressFill.addEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
            }
        }

        private resumeStoryWithDelay(elapsedTime: number): void {
            if (this.currentIndex >= this.totalSlides) {
                this.complete();
                return;
            }

            this.isPlaying = true;
            this.isPaused = false;
            this.startTime = Date.now() - elapsedTime;

            const progressFill = this.container.querySelector<HTMLElement>(
                `[data-index="${this.currentIndex}"] .progress-fill`,
            );
            if (progressFill) {
                progressFill.removeEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
                progressFill.style.animationDuration = `${this.duration}s`;
                // Use negative delay to start animation partway through
                progressFill.style.animationDelay = `-${elapsedTime / 1000}s`;
                progressFill.classList.add("active");
                progressFill.addEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
            }
        }

        private nextStory(): void {
            if (this.currentIndex < this.totalSlides - 1) {
                this.showSlide(this.currentIndex + 1);
                this.startStory();
            } else {
                this.complete();
            }
        }

        public pause(): void {
            if (!this.isPlaying || this.isPaused) return;

            this.isPaused = true;
            this.pausedTime = Date.now() - this.startTime;

            const progressFill = this.container.querySelector<HTMLElement>(
                `[data-index="${this.currentIndex}"] .progress-fill`,
            );
            if (progressFill) {
                progressFill.style.animationPlayState = "paused";
            }
        }

        public resume(): void {
            if (!this.isPaused) return;

            this.isPaused = false;

            const progressFill = this.container.querySelector<HTMLElement>(
                `[data-index="${this.currentIndex}"] .progress-fill`,
            );
            if (progressFill) {
                progressFill.style.animationPlayState = "running";
            }

            this.startTime = Date.now() - this.pausedTime;
        }

        public pauseForNavigation(): void {
            this.isPaused = true;
            this.pausedTime = Date.now() - this.startTime;

            // Store state in sessionStorage
            sessionStorage.setItem(
                "story-current-index",
                this.currentIndex.toString(),
            );
            sessionStorage.setItem(
                "story-elapsed-time",
                this.pausedTime.toString(),
            );

            const progressFill = this.container.querySelector<HTMLElement>(
                `[data-index="${this.currentIndex}"] .progress-fill`,
            );
            if (progressFill) {
                progressFill.style.animationPlayState = "paused";
                progressFill.removeEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
            }
        }

        public resumeFromNavigation(
            storedIndex: number,
            elapsedTime: number,
        ): void {
            this.currentIndex = storedIndex;
            this.showSlide(storedIndex);
            this.resumeStoryWithDelay(elapsedTime);
        }

        private complete(): void {
            this.isPlaying = false;

            const progressBars =
                this.container.querySelectorAll<HTMLElement>("[data-index]");
            progressBars.forEach((bar) => {
                const fill = bar.querySelector<HTMLElement>(".progress-fill");
                if (!fill) return;

                fill.classList.remove("active", "completed");
                fill.style.width = "0%";
                fill.style.animationDuration = "";
                fill.style.animationDelay = "";
                fill.style.animationPlayState = "running";
                fill.removeEventListener(
                    "animationend",
                    this.handleAnimationEnd,
                );
            });

            this.currentIndex = 0;
            this.showSlide(0);

            // Use requestAnimationFrame to ensure DOM updates, then restart
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    this.startStory();
                });
            });
        }
    }

    // Store instance globally
    let storiesPlayerInstance: StoriesPlayer | null = null;

    // Initialize
    const container = document.getElementById("storiesContainer");
    if (container) {
        const totalSlides = container.querySelectorAll(".story-slide").length;
        storiesPlayerInstance = new StoriesPlayer(container, totalSlides);
        storiesPlayerInstance.init();
    }

    // Pause before navigation
    document.addEventListener("astro:before-preparation", () => {
        if (storiesPlayerInstance) {
            storiesPlayerInstance.pauseForNavigation();
        }
    });

    // Resume after navigation
    document.addEventListener("astro:after-swap", () => {
        const container = document.getElementById("storiesContainer");
        if (container) {
            const storedIndex = parseInt(
                sessionStorage.getItem("story-current-index") || "0",
                10,
            );
            const elapsedTime = parseInt(
                sessionStorage.getItem("story-elapsed-time") || "0",
                10,
            );

            const totalSlides =
                container.querySelectorAll(".story-slide").length;
            storiesPlayerInstance = new StoriesPlayer(container, totalSlides);
            storiesPlayerInstance.resumeFromNavigation(
                storedIndex,
                elapsedTime,
            );
        }
    });
</script>
