<aside
    id="tocContainer"
    class="sticky top-[74px] border border-gray-300 rounded-md overflow-hidden hidden md:w-80 mb-8"
>
    <!-- Fixed Header -->
    <div class="px-6 py-2 border-b border-gray-300 bg-white">
        <h3 class="font-bold">Daftar Isi</h3>
    </div>

    <!-- Scrollable List -->
    <ul id="tocList" class="max-h-40 md:max-h-96 overflow-y-auto p-4 space-y-2">
        <!-- Items will be inserted here -->
    </ul>
</aside>

<script>
    class TableOfContents {
        private container: HTMLElement;
        private list: HTMLElement;
        private threadId: string = "";
        private currentUrl: string = "";

        constructor() {
            this.container = document.getElementById("tocContainer")!;
            this.list = document.getElementById("tocList")!;

            if (!this.container || !this.list) return;

            const threadId = new URLSearchParams(window.location.search).get(
                "thread",
            );

            const backButton = document.querySelector<HTMLAnchorElement>(
                "[data-back-to-blog]",
            );

            if (threadId) {
                this.threadId = threadId;
                this.currentUrl = window.location.pathname;
                this.container.classList.remove("hidden");
                if (backButton) {
                    backButton.innerHTML = `
                      <span class="icon-chevron-left text-lg font-bold"></span>
                      Utas
                    `;
                }
            } else {
                this.container.style.display = "none";
            }

            this.init();
        }

        private async init() {
            try {
                const response = await fetch(`/threads/${this.threadId}.json`);

                if (!response.ok) {
                    this.container.style.display = "none";
                    return;
                }

                const data = await response.json();
                this.renderList(data.articles);
            } catch (error) {
                console.error("Failed to load TOC:", error);
                this.container.style.display = "none";
            }
        }

        private renderList(articles: any[]) {
            this.list.innerHTML = "";
            // create overview link
            const li = document.createElement("li");
            const link = document.createElement("a");
            link.href = `/threads/${this.threadId}`;
            link.className =
                "flex items-center gap-3 py-2 px-2 rounded hover:bg-gray-100 transition-colors";

            const circle = document.createElement("span");
            circle.className = `text-lg flex-shrink-0 w-8 h-8 rounded-full border border-gray-900 flex items-center justify-center text-sm bg-white text-gray-900`;
            circle.textContent = "â˜…";

            const title = document.createElement("span");
            title.textContent = "Sekapur Sirih";

            link.appendChild(circle);
            link.appendChild(title);
            li.appendChild(link);
            this.list.appendChild(li);

            articles.forEach((article, index) => {
                const li = document.createElement("li");
                const link = document.createElement("a");
                const isActive = this.currentUrl === `/articles/${article.id}`;

                console.log("current url", this.currentUrl);
                link.href = `/articles/${article.id}?thread=${this.threadId}`;
                link.className =
                    "flex items-center gap-3 py-2 px-2 rounded hover:bg-gray-100 transition-colors";

                if (isActive) {
                    link.classList.add("font-bold");
                }

                // Number circle
                const circle = document.createElement("span");
                circle.className = `flex-shrink-0 w-8 h-8 rounded-full border border-gray-900 flex items-center justify-center text-sm ${
                    isActive
                        ? "bg-gray-900 text-white"
                        : "bg-white text-gray-900"
                }`;
                circle.textContent = (index + 1).toString();

                // Title
                const title = document.createElement("span");
                title.textContent = article.title;
                title.className = "flex-1 line-clamp-2";

                link.appendChild(circle);
                link.appendChild(title);
                li.appendChild(link);
                this.list.appendChild(li);

                // Scroll to active item
                if (isActive) {
                    requestAnimationFrame(() => {
                        const elemTop = li.offsetTop;
                        const elemBottom = elemTop - li.offsetHeight;

                        this.list.scrollTo({
                            top: elemBottom,
                        });
                    });
                }
            });
        }
    }

    // Initialize
    function initialize() {
        new TableOfContents();
    }

    initialize();
    document.addEventListener("astro:after-swap", initialize);
</script>
