---
interface Props {
    currentArticleId: string;
}

const { currentArticleId } = Astro.props;
---

<nav
    id="iterator"
    class="hidden items-center justify-between py-8 border-t border-gray-300 mt-8"
    data-article-id={currentArticleId}
>
    <div class="flex-1">
        <a
            id="prevLink"
            href="#"
            class="hidden items-center gap-2 py-2 font-semibold"
        >
            <span class="icon-chevron-left text-lg font-bold"></span>
            <div>Sebelumnya</div>
        </a>
    </div>

    <div class="flex-1 flex justify-end">
        <a
            id="nextLink"
            href="#"
            class="hidden items-center gap-2 py-2 rounded-md font-semibold"
        >
            <div>Selanjutnya</div>
            <span class="icon-chevron-right text-lg font-bold"></span>
        </a>
    </div>
</nav>

<script>
    import type { CollectionEntry } from "astro:content";

    class Iterator {
        private iterator: HTMLElement;
        private currentArticleId: string = "";
        private threadId: string | null = null;

        constructor() {
            this.iterator = document.getElementById("iterator")!;
            if (!this.iterator) return;

            this.currentArticleId = this.iterator.dataset.articleId || "";

            // Get thread from URL search params
            const params = new URLSearchParams(window.location.search);
            this.threadId = params.get("thread");

            if (this.threadId) {
                this.init();
            }
        }

        private async init() {
            try {
                const response = await fetch(`/threads/${this.threadId}.json`);

                if (!response.ok) {
                    return;
                }

                const data: { articles: CollectionEntry<"articles">[] } =
                    await response.json();
                const articles = data.articles;

                // Find current article index
                const currentIndex = articles.findIndex(
                    (a: any) => a.id === this.currentArticleId,
                );

                if (currentIndex === -1) {
                    // Current article not in this thread
                    return;
                }

                // Show iterator
                this.iterator.classList.remove("hidden");
                this.iterator.classList.add("flex");

                // Setup prev button
                if (currentIndex > 0) {
                    const prevArticle = articles[currentIndex - 1];
                    this.setupNavButton("prev", prevArticle);
                }

                if (currentIndex === 0) {
                    // Setup overview button
                    this.setupOverviewButton();
                }

                // Setup next button
                if (currentIndex < articles.length - 1) {
                    const nextArticle = articles[currentIndex + 1];
                    this.setupNavButton("next", nextArticle);
                }
            } catch (error) {
                console.error("Failed to load thread navigation:", error);
            }
        }

        private setupOverviewButton() {
            const link = document.getElementById(
                "prevLink",
            ) as HTMLAnchorElement;

            if (link) {
                link.href = `/threads/${this.threadId}`;
                link.classList.remove("hidden");
                link.classList.add("inline-flex");
            }
        }

        private setupNavButton(direction: "prev" | "next", article: any) {
            const link = document.getElementById(
                `${direction}Link`,
            ) as HTMLAnchorElement;

            if (link) {
                link.href = `/articles/${article.id}?thread=${this.threadId}`;
                link.classList.remove("hidden");
                link.classList.add("inline-flex");
            }
        }
    }

    // Initialize
    new Iterator();

    document.addEventListener("astro:after-swap", () => {
        new Iterator();
    });
</script>
