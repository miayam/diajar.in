---
interface Props {
    currentArticleId: string;
}

const { currentArticleId } = Astro.props;
---

<nav
    id="iterator"
    class="hidden items-center justify-between py-8 px-4 border-t border-gray-300 mt-8"
    data-article-id={currentArticleId}
>
    <div class="flex-1">
        <a
            id="prevLink"
            href="#"
            class="hidden items-center gap-2 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors"
        >
            <span>←</span>
            <div class="text-left">
                <div class="text-xs text-gray-600">Sebelumnya</div>
                <div id="prevTitle" class="font-medium"></div>
            </div>
        </a>
    </div>

    <div id="threadLabel" class="text-center text-sm text-gray-600"></div>

    <div class="flex-1 flex justify-end">
        <a
            id="nextLink"
            href="#"
            class="hidden items-center gap-2 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors"
        >
            <div class="text-right">
                <div class="text-xs text-gray-600">Selanjutnya</div>
                <div id="nextTitle" class="font-medium"></div>
            </div>
            <span>→</span>
        </a>
    </div>
</nav>

<script>
    class ArticleIterator {
        private iterator: HTMLElement;
        private currentArticleId: string = "";
        private threadId: string | null = null;

        constructor() {
            this.iterator = document.getElementById("iterator")!;
            if (!this.iterator) return;

            this.currentArticleId = this.iterator.dataset.articleId || "";

            // Get thread from URL search params
            const params = new URLSearchParams(window.location.search);
            this.threadId = params.get("thread");

            if (this.threadId) {
                this.init();
            }
        }

        private async init() {
            try {
                const response = await fetch(`/threads/${this.threadId}.json`);

                if (!response.ok) {
                    return;
                }

                const data = await response.json();
                const articles = data.articles;

                // Find current article index
                const currentIndex = articles.findIndex(
                    (a: any) => a.id === this.currentArticleId,
                );

                if (currentIndex === -1) {
                    // Current article not in this thread
                    return;
                }

                // Show iterator
                this.iterator.classList.remove("hidden");
                this.iterator.classList.add("flex");

                // Set thread label
                const threadLabel = document.getElementById("threadLabel");
                if (threadLabel) {
                    threadLabel.textContent = data.thread.label;
                }

                // Setup prev button
                if (currentIndex > 0) {
                    const prevArticle = articles[currentIndex - 1];
                    this.setupNavButton("prev", prevArticle);
                }

                // Setup next button
                if (currentIndex < articles.length - 1) {
                    const nextArticle = articles[currentIndex + 1];
                    this.setupNavButton("next", nextArticle);
                }
            } catch (error) {
                console.error("Failed to load thread navigation:", error);
            }
        }

        private setupNavButton(direction: "prev" | "next", article: any) {
            const link = document.getElementById(
                `${direction}Link`,
            ) as HTMLAnchorElement;
            const title = document.getElementById(`${direction}Title`);

            if (link && title) {
                link.href = `/articles/${article.id}?thread=${this.threadId}`;
                link.classList.remove("hidden");
                link.classList.add("inline-flex");
                title.textContent = article.title;
            }
        }
    }

    // Initialize
    new ArticleIterator();

    document.addEventListener("astro:after-swap", () => {
        new ArticleIterator();
    });
</script>
