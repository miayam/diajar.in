---
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import Article from "@/templates/Article.astro";
import ArticleView from "@/components/display/ArticleView.astro";
import { getCollection, getEntry, render } from "astro:content";
import { markdown } from "@astropub/md";
import { Image } from "astro:assets";

export const getStaticPaths = (async () => {
    const articles = await getCollection("articles", ({ data }) => {
        return data.draft !== true; // Filter out drafts
    });

    return articles.map((article) => ({
        params: { slug: article.id },
        props: { article },
    }));
}) satisfies GetStaticPaths;

type Props = {
    article: CollectionEntry<"articles">;
};

const { article } = Astro.props;

// Load referenced data
const tags = await Promise.all(article.data.tags.map((tag) => getEntry(tag)));
const { Content } = await render(article);
---

<Article title={article.data.title}>
    {
        article.data.featuredImage ? (
            <figure slot="featured-image" class="flex max-h-80 relative">
                <Image
                    width={200}
                    height={200}
                    decoding="async"
                    loading="eager"
                    src={article.data.featuredImage}
                    alt={article.data.title}
                    class="object-cover w-full"
                />
                <figcaption class="absolute bg-gray-900 px-3 py-1 text-white bottom-4 right-4 text-xs">
                    {markdown(article.data.featuredImageCaption || "")}
                </figcaption>
            </figure>
        ) : (
            <div class="md:h-0 h-8" />
        )
    }

    <ArticleView article={article} tags={tags}>
        <Content />
    </ArticleView>
</Article>
