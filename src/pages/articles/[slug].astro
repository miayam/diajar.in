---
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import Article from "@/templates/Article.astro";
import Masthead from "@/components/display/Masthead.astro";
import MetaTags from "@/components/structure/MetaTags.astro";
import SchemaOrg from "@/components/structure/SchemaOrg.astro";
import BackLink from "@/components/navigation/BackLink.astro";
import ArticleView from "@/components/display/ArticleView.astro";
import DynamicTableOfContents from "@/components/navigation/DynamicTableOfContents.astro";
import Iterator from "@/components/navigation/Iterator.astro";
import ShareButtons from "@/components/navigation/ShareButtons.astro";
import { getCollection, getEntry, render } from "astro:content";
import createExcerpt from "@/utils/createExcerpt";
import { getImage } from "astro:assets";

export const getStaticPaths = (async () => {
    const articles = await getCollection("articles", ({ data }) => {
        return data.draft !== true; // Filter out drafts
    });
    const authors = await getCollection("authors");

    return articles.map((article) => {
        const author = authors.filter(
            (item) => item.id == article.data.author.id,
        )[0];
        return {
            params: { slug: article.id },
            props: { article, author },
        };
    });
}) satisfies GetStaticPaths;

type Props = {
    article: CollectionEntry<"articles">;
    author: CollectionEntry<"authors">;
};

const { article, author } = Astro.props;

// Load referenced data
const tags = await Promise.all(article.data.tags.map((tag) => getEntry(tag)));
const { Content } = await render(article);
const featuredImage = article.data.featuredImage
    ? await getImage({ src: article.data.featuredImage })
    : undefined;
---

<Article title={`Diajar: ${article.data.title}`}>
    <SchemaOrg
        slot="schema"
        data={{
            "@context": "https://schema.org",
            "@type": "BlogPosting",
            headline: `Diajar: ${article.data.title}`,
            description: `${createExcerpt(article.body || "")
                .substring(0, 150)
                .trim()}...`,
            datePublished: article.data.publishDate?.toISOString(),
            image: {
                "@type": "ImageObject",
                "@id": `${new URL(featuredImage?.src || "/logo.svg", Astro.site)}`,
                url: `${new URL(featuredImage?.src || "/logo.svg", Astro.site)}`,
            },
            author: {
                "@type": "Person",
                name: author.data.name,
                email: author.data.email,
            },
            url: `${Astro.site}articles/${article.id}`,
        }}
    />

    <MetaTags
        slot="meta-tags"
        title={`Diajar: ${article.data.title}`}
        description={`${createExcerpt(article.body || "")
            .substring(0, 150)
            .trim()}...`}
        url={`${Astro.site}articles/${article.id}`}
        author={author.data.name}
        image={`${new URL(featuredImage?.src || "/logo.svg", Astro.site)}`}
    />

    {
        article.data.featuredImage ? (
            <Masthead
                slot="featured-image"
                src={article.data.featuredImage}
                alt={article.data.title}
                caption={article.data.caption}
            />
        ) : (
            <div slot="featured-image" class="md:h-0 h-8" />
        )
    }

    <BackLink
        slot="back-link"
        className="text-sm fixed top-4 md:text-base md:sticky md:max-w-80 md:top-8 mb-4"
    >
        Kembali
    </BackLink>

    <DynamicTableOfContents slot="table-of-contents" />

    <ArticleView article={article} tags={tags}>
        <Content />
    </ArticleView>

    <ShareButtons
        slot="share"
        url={`${Astro.site}articles/${article.id}`}
        text={createExcerpt(article.body || "").substring(0, 140)}
        title={article.data.title}
    />

    <Iterator currentArticleId={article.id} />
</Article>
