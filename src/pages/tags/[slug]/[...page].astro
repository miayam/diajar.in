---
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { getCollection } from "astro:content";

export const getStaticPaths = (async ({ paginate }) => {
    const allTags = await getCollection("tags");
    const allArticles = await getCollection("articles", (entry) => {
        return entry.data.draft !== true;
    });

    // Generate paginated paths for each thread
    return allTags.flatMap((tag) => {
        // Filter articles that belong to this thread
        const tagArticles = allArticles
            .filter((article) => article.data.tags.some((t) => t.id === tag.id))
            .sort(
                (a, b) =>
                    b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
            );

        // Create paginated routes for this thread
        return paginate(tagArticles, {
            params: { slug: tag.id },
            pageSize: 2,
            props: { tag },
        });
    });
}) satisfies GetStaticPaths;

type Props = {
    page: Page<CollectionEntry<"articles">>;
    tag: CollectionEntry<"tags">;
};

const { page, tag } = Astro.props;
const { Content } = await render(tag);
---

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{tag.data.label} - Page {page.currentPage}</title>
    </head>
    <body>
        <h1>{tag.data.label}</h1>
        <Content />
        <p>Articles in this tags</p>

        <ul>
            {
                page.data.map((article) => (
                    <li>
                        <a href={`/articles/${article.id}`}>
                            <h2>{article.data.title}</h2>
                            <time
                                datetime={article.data.publishDate.toISOString()}
                            >
                                {article.data.publishDate.toLocaleDateString()}
                            </time>
                            {article.data.excerpt && (
                                <p>{article.data.excerpt}</p>
                            )}
                        </a>
                    </li>
                ))
            }
        </ul>

        <nav aria-label="Pagination">
            {page.url.prev && <a href={page.url.prev}>← Previous</a>}
            <span>Page {page.currentPage} of {page.lastPage}</span>
            {page.url.next && <a href={page.url.next}>Next →</a>}
        </nav>
    </body>
</html>
