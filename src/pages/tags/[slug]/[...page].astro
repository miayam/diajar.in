---
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import DefaultCard from "@/components/display/DefaultCard.astro";
import { render } from "astro:content";
import { getCollection } from "astro:content";
import Default from "@/templates/Default.astro";
import StoriesPlayer from "@/components/interactive/StoriesPlayer.astro";
import PriorityMenu from "@/components/navigation/PriorityMenu.astro";

export const getStaticPaths = (async ({ paginate }) => {
    const allTags = await getCollection("tags");
    const allArticles = await getCollection("articles", (entry) => {
        return entry.data.draft !== true;
    });

    // Generate paginated paths for each thread
    return allTags.flatMap((tag) => {
        // Filter articles that belong to this thread
        const tagArticles = allArticles
            .filter((article) => article.data.tags.some((t) => t.id === tag.id))
            .sort(
                (a, b) =>
                    b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
            );

        // Create paginated routes for this thread
        return paginate(tagArticles, {
            params: { slug: tag.id },
            pageSize: 2,
            props: { tag },
        });
    });
}) satisfies GetStaticPaths;

type Props = {
    page: Page<CollectionEntry<"articles">>;
    tag: CollectionEntry<"tags">;
};

const { page, tag } = Astro.props;
const { Content } = await render(tag);

const menuItems = [
    { label: "Semua", href: "/" },
    { label: "Gagasan", href: "/tags/gagasan" },
    { label: "Pustaka", href: "/tags/pustaka" },
    { label: "Rupa & Rasa", href: "/tags/rupa-rasa" },
    { label: "Perkakas", href: "/tags/perkakas" },
    { label: "Lain-lain", href: "/threads" },
];

const currentPath = Astro.url.pathname;
---

<Default title={`${tag.data.label} - Page ${page.currentPage}`}>
    <link rel="stylesheet" href="/style.css" slot="icons" />
    <StoriesPlayer />
    <PriorityMenu items={menuItems} currentPath={currentPath} />
    <div class="grid grid-cols-[1fr_min(40rem,100%)_1fr] w-full my-4">
        <ul class="col-start-2 flex flex-col gap-4 px-4">
            {
                page.data.map((article) => (
                    <li>
                        <DefaultCard article={article} />
                    </li>
                ))
            }
        </ul>
    </div>

    <nav aria-label="Pagination">
        {page.url.prev && <a href={page.url.prev}>← Previous</a>}
        <span>Page {page.currentPage} of {page.lastPage}</span>
        {page.url.next && <a href={page.url.next}>Next →</a>}
    </nav>
</Default>
