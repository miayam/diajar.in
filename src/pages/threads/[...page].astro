---
import ThreadList from "@/templates/ThreadList.astro";
import ThreadCard from "@/components/display/ThreadCard.astro";
import Pagination from "@/components/navigation/Pagination.astro";
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export const getStaticPaths = (async ({ paginate }) => {
    const allThreads = await getCollection("threads");
    const allArticles = await getCollection("articles", (entry) => {
        return entry.data.draft !== true;
    });

    // Sort threads if needed (by name or any other criteria)
    const sortedThreads = allThreads
        .sort((a, b) => a.data.label.localeCompare(b.data.label))
        .map((thread) => {
            const count = allArticles.filter((article) =>
                article.data.threads.some((t) => t.id === thread.id),
            ).length;
            return {
                thread,
                articleCount: count,
            };
        });

    return paginate(sortedThreads, { pageSize: 9 });
}) satisfies GetStaticPaths;

type ThreadWithCount = {
    thread: CollectionEntry<"threads">;
    articleCount: number;
};

type Props = {
    page: Page<ThreadWithCount>;
};

const { page } = Astro.props;
---

<ThreadList title={`Diajar Utas | Halaman ${page.currentPage}`}>
    <ul
        class="col-start-2 grid lg:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-8 px-4"
    >
        {
            page.data.map(({ thread, articleCount }) => (
                <li>
                    <ThreadCard
                        href={`/threads/${thread.id}`}
                        title={thread.data.name}
                        articleCount={articleCount}
                        description={thread.body || "Deskripsi.."}
                    />
                </li>
            ))
        }
    </ul>

    <Pagination
        currentPage={page.currentPage}
        lastPage={page.lastPage}
        urlPattern="/threads"
        className="col-start-2"
    />
</ThreadList>
