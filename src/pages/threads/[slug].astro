---
import Default from "@/templates/Default.astro";
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { getCollection, getEntry } from "astro:content";

export const getStaticPaths = (async () => {
    const threads = await getCollection("threads");
    const allArticles = await getCollection("articles", (entry) => {
        return entry.data.draft !== true;
    });

    return threads.map((thread) => {
        // Get articles for this thread
        const threadArticles = allArticles
            .filter((article) =>
                article.data.threads.some((t) => t.id === thread.id),
            )
            .sort(
                (a, b) =>
                    b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
            );

        return {
            params: { slug: thread.id },
            props: { thread, articles: threadArticles },
        };
    });
}) satisfies GetStaticPaths;

type Props = {
    thread: CollectionEntry<"threads">;
    articles: CollectionEntry<"articles">[];
};

const { thread, articles } = Astro.props;
const { Content } = await render(thread);
---

<Default title={thread.data.label}>
    <h1>{thread.data.label}</h1>
    <p>{thread.data.name}</p>
    <p><Content /></p>

    <h2>Articles in this thread</h2>
    <ul>
        {
            articles.map((article) => (
                <li>
                    <a href={`/articles/${article.id}`}>
                        <h3>{article.data.title}</h3>
                        <time datetime={article.data.publishDate.toISOString()}>
                            {article.data.publishDate.toLocaleDateString()}
                        </time>
                        {article.data.excerpt && <p>{article.data.excerpt}</p>}
                    </a>
                </li>
            ))
        }
    </ul>

    <a href="/threads">‚Üê Back to threads</a>
</Default>
